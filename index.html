<!doctype html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Sistema de Solicitações da População</title>
    <style>
        :root {
            --primary: #1e88e5;
            --muted: #666
        }

        * {
            box-sizing: border-box
        }

        body {
            font-family: Inter, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
            margin: 0;
            background: #f6f8fb;
            color: #111
        }

        header {
            background: linear-gradient(90deg, var(--primary), #6fb1ff);
            color: white;
            padding: 20px
        }

        .container {
            max-width: 1000px;
            margin: 20px auto;
            padding: 16px
        }

        h1 {
            margin: 0;
            font-size: 1.4rem
        }

        .layout {
            display: grid;
            grid-template-columns: 1fr 360px;
            gap: 18px
        }

        @media(max-width:880px) {
            .layout {
                grid-template-columns: 1fr
            }

            .aside {
                order: 2
            }
        }

        .card {
            background: white;
            border-radius: 10px;
            padding: 14px;
            box-shadow: 0 6px 18px rgba(15, 23, 42, 0.06)
        }

        label {
            display: block;
            margin-top: 10px;
            font-weight: 600
        }

        input[type=text],
        input[type=email],
        select,
        textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #e6e9ef;
            border-radius: 8px;
            margin-top: 6px
        }

        textarea {
            min-height: 100px
        }

        .row {
            display: flex;
            gap: 10px
        }

        button {
            background: var(--primary);
            color: white;
            border: 0;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer
        }

        button.ghost {
            background: transparent;
            color: var(--primary);
            border: 1px solid rgba(30, 136, 229, 0.2)
        }

        .small {
            font-size: 0.85rem;
            color: var(--muted)
        }

        .list {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 8px
        }

        .item {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #eef3fb;
            background: #fff
        }

        .meta {
            display: flex;
            justify-content: space-between;
            align-items: center
        }

        .status {
            padding: 6px 8px;
            border-radius: 8px;
            font-weight: 700
        }

        .status.recebido {
            background: #fff3cd;
            color: #8a6d00;
            border: 1px solid rgba(138, 109, 0, 0.08)
        }

        .status.andamento {
            background: #e8f7ff;
            color: #0b6aa8
        }

        .status.concluido {
            background: #e6ffed;
            color: #166534
        }

        .preview {
            margin-top: 8px;
            max-height: 160px;
            object-fit: cover;
            border-radius: 6px
        }

        .controls {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 10px
        }

        .muted {
            color: #666;
            font-size: 0.9rem
        }

        .mapbox {
            height: 220px;
            border-radius: 8px;
            border: 1px dashed #dfe8f7;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #789
        }

        .admin-actions {
            display: flex;
            gap: 6px
        }

        .kbd {
            background: #f1f5f9;
            padding: 6px 8px;
            border-radius: 6px;
            font-family: monospace
        }
    </style>
</head>

<body>
    <header>
        <div class="container" style="display:flex;align-items:center;justify-content:space-between">
            <div>
                <h1>Sistema de Solicitações da População</h1>
                <div class="small">Protótipo front-end — rodar localmente</div>
            </div>
            <div class="small">Prefeitura • Protótipo</div>
        </div>
    </header>

    <main class="container">
        <div class="layout">

            <section class="card">
                <h2>Nova Solicitação</h2>
                <p class="muted">Preencha os dados abaixo. As solicitações serão salvas no seu navegador (localStorage).
                </p>

                <label for="type">Categoria</label>
                <select id="type">
                    <option>Iluminação pública</option>
                    <option>Buraco/ pavimentação</option>
                    <option>Coleta de lixo</option>
                    <option>Árvore/vegetação</option>
                    <option>Outro</option>
                </select>

                <label for="title">Título curto</label>
                <input id="title" type="text" placeholder="Ex: Buraco grande na Rua X" />

                <label for="desc">Descrição</label>
                <textarea id="desc" placeholder="Descreva o problema com detalhes..."></textarea>

                <label>Localização</label>
                <div class="row">
                    <input id="address" type="text" placeholder="Digite um endereço (opcional)" />
                    <button id="use-loc" class="ghost" type="button">Usar minha localização</button>
                </div>
                <div id="coords" class="small muted">Nenhuma coordenada detectada.</div>

                <label for="photo">Foto (opcional)</label>
                <input id="photo" type="file" accept="image/*" />
                <img id="preview" class="preview" style="display:none" />

                <div class="controls">
                    <button id="submit">Enviar Solicitação</button>
                    <button id="clear" class="ghost" type="button">Limpar formulário</button>
                </div>

                <hr style="margin:14px 0" />
                <h3>Visão rápida</h3>
                <div class="row" style="gap:12px">
                    <div class="card" style="flex:1;padding:10px">
                        <div class="small">Total de solicitações</div>
                        <div id="stat-total" style="font-size:1.4rem;font-weight:700">0</div>
                    </div>
                    <div class="card" style="width:150px;padding:10px">
                        <div class="small">Abertas</div>
                        <div id="stat-open" style="font-size:1.2rem;font-weight:700">0</div>
                    </div>
                </div>

            </section>

            <aside class="aside">
                <div class="card">
                    <h3>Painel de Acompanhamento</h3>
                    <p class="small">Lista de solicitações registradas (dados salvos localmente). Clique para alternar o
                        status.</p>

                    <div id="list" class="list" aria-live="polite"></div>

                    <div style="margin-top:12px;display:flex;justify-content:space-between;align-items:center">
                        <div class="small">Modo:</div>
                        <div class="row">
                            <button id="filter-all" class="ghost">Todas</button>
                            <button id="filter-open" class="ghost">Abertas</button>
                            <button id="filter-closed" class="ghost">Concluídas</button>
                        </div>
                    </div>

                </div>

                <div class="card" style="margin-top:12px">
                    <h4>Mapa (simples)</h4>
                    <div class="mapbox" id="mapbox">Mapa não implementado — somente protótipo</div>
                    <div class="small" style="margin-top:8px">Sugestão: integrar Google Maps ou Leaflet em uma versão
                        com servidor/ API key.</div>
                </div>

            </aside>

        </div>
    </main>

    <script>
        // ======== simples model + localStorage ========
        const photoInput = document.getElementById('photo');
        const preview = document.getElementById('preview');
        const useLocBtn = document.getElementById('use-loc');
        const coordsText = document.getElementById('coords');
        const submitBtn = document.getElementById('submit');
        const clearBtn = document.getElementById('clear');
        const listEl = document.getElementById('list');
        const statTotal = document.getElementById('stat-total');
        const statOpen = document.getElementById('stat-open');

        const storageKey = 'sistema_solicitacoes_v1';
        let items = loadItems();
        let filter = 'all';

        function saveItems() { localStorage.setItem(storageKey, JSON.stringify(items)); }
        function loadItems() { try { const s = localStorage.getItem(storageKey); return s ? JSON.parse(s) : [] } catch (e) { return [] } }

        // preview da foto como dataURL
        photoInput.addEventListener('change', async (e) => {
            const f = e.target.files && e.target.files[0];
            if (!f) { preview.style.display = 'none'; preview.src = ''; return }
            const reader = new FileReader();
            reader.onload = () => { preview.src = reader.result; preview.style.display = 'block' };
            reader.readAsDataURL(f);
        });

        useLocBtn.addEventListener('click', () => {
            if (!navigator.geolocation) { coordsText.textContent = 'Geolocalização não suportada pelo navegador.'; return }
            coordsText.textContent = 'Buscando localização...';
            navigator.geolocation.getCurrentPosition(pos => {
                const lat = pos.coords.latitude.toFixed(6);
                const lng = pos.coords.longitude.toFixed(6);
                coordsText.textContent = `Coordenadas: ${lat}, ${lng}`;
                coordsText.dataset.lat = lat; coordsText.dataset.lng = lng;
            }, err => { coordsText.textContent = 'Permissão negada ou erro ao obter localização.' })
        });

        clearBtn.addEventListener('click', () => { document.getElementById('type').value = 'Iluminação pública'; document.getElementById('title').value = ''; document.getElementById('desc').value = ''; document.getElementById('address').value = ''; photoInput.value = ''; preview.style.display = 'none'; coordsText.textContent = 'Nenhuma coordenada detectada.'; delete coordsText.dataset.lat; delete coordsText.dataset.lng });

        submitBtn.addEventListener('click', async () => {
            const type = document.getElementById('type').value;
            const title = document.getElementById('title').value.trim();
            const desc = document.getElementById('desc').value.trim();
            const address = document.getElementById('address').value.trim();
            if (!title || !desc) { alert('Por favor preencha título e descrição.'); return }

            let photoData = null;
            if (photoInput.files && photoInput.files[0]) {
                photoData = await fileToDataUrl(photoInput.files[0]);
            }

            const item = {
                id: 'id_' + Date.now(),
                type, title, desc, address, photo: photoData,
                lat: coordsText.dataset.lat || null, lng: coordsText.dataset.lng || null,
                status: 'recebido', created: new Date().toISOString()
            };
            items.unshift(item);
            saveItems();
            render();
            // feedback
            alert('Solicitação enviada com sucesso (salva localmente).');
            clearBtn.click();
        });

        function fileToDataUrl(file) { return new Promise((res, rej) => { const r = new FileReader(); r.onload = () => res(r.result); r.onerror = rej; r.readAsDataURL(file) }) }

        function render() {
            // stats
            statTotal.textContent = items.length;
            const openCount = items.filter(i => i.status !== 'concluido').length;
            statOpen.textContent = openCount;

            // list
            listEl.innerHTML = '';
            const filtered = items.filter(i => {
                if (filter === 'open') return i.status !== 'concluido';
                if (filter === 'closed') return i.status === 'concluido';
                return true;
            });

            if (filtered.length === 0) { listEl.innerHTML = '<div class="small muted">Nenhuma solicitação registrada.</div>'; return }

            for (const it of filtered) {
                const div = document.createElement('div'); div.className = 'item';
                const statusClass = it.status === 'recebido' ? 'recebido' : (it.status === 'andamento' ? 'andamento' : 'concluido');
                div.innerHTML = `
          <div class="meta">
            <div>
              <div style="font-weight:700">${escapeHtml(it.title)}</div>
              <div class="small muted">${escapeHtml(it.type)} • ${new Date(it.created).toLocaleString()}</div>
            </div>
            <div style="text-align:right">
              <div class="status ${statusClass}">${labelFromStatus(it.status)}</div>
            </div>
          </div>
          <div style="margin-top:8px">${escapeHtml(it.desc)}</div>
          ${it.address ? `<div class="small muted" style="margin-top:8px">Endereço: ${escapeHtml(it.address)}</div>` : ''}
          ${it.lat ? `<div class="small muted" style="margin-top:6px">Coordenadas: ${it.lat}, ${it.lng}</div>` : ''}
          ${it.photo ? `<img src="${it.photo}" style="margin-top:8px;max-height:140px;border-radius:6px;object-fit:cover;width:100%">` : ''}
          <div style="margin-top:8px;display:flex;justify-content:space-between;align-items:center">
            <div class="small muted">ID: <span class="kbd">${it.id}</span></div>
            <div class="admin-actions">
              <button data-id="${it.id}" class="ghost btn-toggle">Alternar status</button>
              <button data-id="${it.id}" class="ghost btn-delete">Apagar</button>
            </div>
          </div>
        `;
                listEl.appendChild(div);
            }

            // attach events
            document.querySelectorAll('.btn-toggle').forEach(b => b.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id; toggleStatus(id);
            }));
            document.querySelectorAll('.btn-delete').forEach(b => b.addEventListener('click', (e) => {
                const id = e.currentTarget.dataset.id; if (confirm('Apagar solicitação?')) { items = items.filter(x => x.id !== id); saveItems(); render(); }
            }));
        }

        function toggleStatus(id) {
            items = items.map(it => {
                if (it.id !== id) return it;
                const next = it.status === 'recebido' ? 'andamento' : (it.status === 'andamento' ? 'concluido' : 'recebido');
                return { ...it, status: next };
            });
            saveItems(); render();
        }

        function labelFromStatus(s) { return s === 'recebido' ? 'Recebido' : (s === 'andamento' ? 'Em andamento' : 'Concluído') }
        function escapeHtml(s) { if (!s) return ''; return s.replaceAll('&', '&amp;').replaceAll('<', '&lt;').replaceAll('>', '&gt;') }

        // filters
        document.getElementById('filter-all').addEventListener('click', () => { filter = 'all'; render() });
        document.getElementById('filter-open').addEventListener('click', () => { filter = 'open'; render() });
        document.getElementById('filter-closed').addEventListener('click', () => { filter = 'closed'; render() });

        // initial render
        render();

        // keyboard shortcuts: H to clear, N to focus title
        window.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'h') { clearBtn.click() }
            if (e.key.toLowerCase() === 'n') { document.getElementById('title').focus() }
        });

    </script>
</body>